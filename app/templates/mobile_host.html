{% extends "base.html" %}

{% block title %}主持人控制台{% endblock %}

{% block content %}
<div class="mobile-page">
    <div class="mobile-card">
        <h3>主持人控制台</h3>
        <p>你好，{{ participant.name }}</p>
    </div>

    <div class="mobile-card">
        <div class="mobile-card">
            <h4>可用互动</h4>
            <div style="display: grid; gap: 10px;">
                {% if interactions %}
                {% for interaction in interactions %}
                <button type="button" class="btn" onclick="loadPlugin('{{ interaction.id }}')">
                    {{ interaction.name }}
                    <span style="font-size:0.75em; display:block; opacity:0.8; font-weight:normal;">{{
                        interaction.plugin_id }}</span>
                </button>
                {% endfor %}
                {% else %}
                <p>暂无配置的互动</p>
                <p style="font-size: 0.9em; color: #888;">请先在管理员后台配置互动。</p>
                {% endif %}
            </div>
        </div>

        <div class="mobile-card" id="plugin-container" style="display: none;">
            <h4 id="plugin-title">当前互动</h4>
            <div id="plugin-content"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn" style="background-color: #dc3545;" onclick="completePlugin()">完成互动
                    (显示结果)</button>
                <div style="display: flex; gap: 5px; width: 100%;">
                    <input type="number" id="countdown-seconds" placeholder="秒" style="width: 80px; padding: 10px;"
                        value="10">
                    <button type="button" class="btn" style="background-color: #ffc107; color: black;"
                        onclick="startCountdown()">倒计时结束</button>
                </div>
                <button type="button" class="btn" style="background-color: #6c757d;"
                    onclick="exitPlugin()">退出互动</button>
            </div>
        </div>

        <script>
            let currentInteractionId = null;

            async function loadPlugin(interactionId) {
                try {
                    // 1. Start plugin on server (sets active state and triggers display update)
                    const startResponse = await fetch(`/api/plugin/${interactionId}/start`, {
                        method: 'POST'
                    });

                    if (!startResponse.ok) {
                        alert('启动互动失败');
                        return;
                    }

                    currentInteractionId = interactionId;

                    // 2. Load plugin control interface
                    const controlResponse = await fetch(`/mobile/plugin/${interactionId}`);
                    if (!controlResponse.ok) {
                        alert(('加载控制台失败: ' + controlResponse.statusText));
                        return;
                    }
                    const html = await controlResponse.text();
                    const container = document.getElementById('plugin-content');
                    container.innerHTML = html;

                    // Execute embedded scripts
                    Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                        const newScript = document.createElement('script');
                        Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                        newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                        oldScript.parentNode.replaceChild(newScript, oldScript);
                    });

                    // Show plugin control container
                    document.getElementById('plugin-container').style.display = 'block';
                    document.getElementById('plugin-title').innerText = `当前互动: ${interactionId}`;

                    alert('互动已启动，大屏应该已经更新');
                } catch (e) {
                    console.error(e);
                    alert('加载互动失败: ' + e.message);
                }
            }

            async function completePlugin() {
                // ... Call /api/plugin/stop (which stops current active plugin on server)
                // The logic remains same as server tracks current_interaction_id
                // We can just call /api/plugin/stop

                console.log('[Host] completePlugin called');
                try {
                    const response = await fetch(`/api/plugin/stop`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                    if (response.ok) {
                        alert('互动已完成');
                    } else {
                        alert('操作失败');
                    }
                } catch (e) {
                    alert('错误:' + e.message);
                }
            }

            // ... (Other functions rely on /api/plugin endpoints which now use current active plugin on server, 
            // so generic calls like /api/plugin/countdown work fine without ID)

            // Update generic startPlugin if used by templates
            async function startPlugin(interactionId) {
                // Note: templates might pass 'plugin_id' but we need 'interaction_id'.
                // If templates are generic, they might call specific endpoints.
                // For now, let's assume 'loadPlugin' handles the main start.
                // If plugin specific template calls startPlugin with an ID... it might fail if it passes string name.
                // We need to check plugin templates.
                try {
                    const response = await fetch(`/api/plugin/${interactionId}/start`, { method: 'POST' });
                    if (response.ok) {
                        alert('阶段已启动');
                    } else {
                        alert('启动失败');
                    }
                } catch (e) {
                    console.error(e);
                    alert('请求出错');
                }
            }

            async function showStats() {
                if (!confirm("确定要在大屏上显示互动统计排行榜吗？")) return;
                try {
                    const response = await fetch('/api/host/show_stats', { method: 'POST' });
                    if (response.ok) {
                        alert('已显示统计榜单');
                    } else {
                        alert('操作失败');
                    }
                } catch (e) {
                    console.error(e);
                    alert('请求出错');
                }
            }
        </script>

        <div class="mobile-card">
            <h4>其他功能</h4>
            <button type="button" class="btn" style="background-color: #17a2b8;"
                onclick="showStats()">显示互动统计排行榜</button>
        </div>

        <div class="mobile-card">
            <h4>当前状态</h4>
            <p>大屏内容: 首页/签到</p>
        </div>
    </div>
    {% endblock %}