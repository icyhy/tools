<div id="game-container" class="display-page" style="background: #2c3e50; color: white;">
    <div class="header">
        <h1>找数字规律 - 第 <span id="stage-display">1</span> 阶段</h1>
        <div id="timer" style="font-size: 3rem; color: #e74c3c;">30</div>
    </div>
    
    <div id="cloud-container" style="position: relative; width: 90vw; height: 70vh; margin: 0 auto; border: 1px solid #7f8c8d;">
        <!-- Numbers will be injected here via JS -->
    </div>
    
    <div id="result-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; flex-direction: column; align-items: center; justify-content: center;">
        <h1 style="color: #f1c40f;">本轮结果</h1>
        <div style="font-size: 2rem;">正确答案: <span id="missing-numbers" style="color: #2ecc71;"></span></div>
        <div style="font-size: 1.5rem; margin-top: 20px;">参与人数: <span id="participant-count">0</span></div>
        <div style="font-size: 1.5rem;">整体准确率: <span id="accuracy">0%</span></div>
    </div>
</div>

<style>
    .number-item {
        position: absolute;
        font-size: 1.5rem;
        font-weight: bold;
        color: #ecf0f1;
        transition: all 0.5s;
    }
    .stage2-quadrant {
        border: 1px dashed #95a5a6;
    }
    .stage3-row {
        display: flex;
        justify-content: center;
        gap: 10px;
        flex-wrap: wrap;
    }
</style>

<script>
    const ws = new WebSocket(window.location.protocol === 'https:' ? 'wss://' + window.location.host + '/ws/display' : 'ws://' + window.location.host + '/ws/display');
    let numbers = [];
    let stage = 1;
    
    ws.onmessage = function(event) {
        const data = JSON.parse(event.data);
        if (data.type === 'game_start' && data.plugin_id === 'find_numbers') {
            stage = data.stage;
            numbers = data.numbers;
            document.getElementById('stage-display').innerText = stage;
            document.getElementById('result-overlay').style.display = 'none';
            startTimer(data.duration);
            renderNumbers(stage, numbers);
        } else if (data.type === 'game_end' && data.plugin_id === 'find_numbers') {
            showResults(data.results);
        }
    };
    
    function startTimer(duration) {
        let timer = duration;
        const el = document.getElementById('timer');
        el.innerText = timer;
        const interval = setInterval(() => {
            timer--;
            el.innerText = timer;
            if (timer <= 0) {
                clearInterval(interval);
            }
        }, 1000);
    }
    
    function renderNumbers(stage, nums) {
        const container = document.getElementById('cloud-container');
        container.innerHTML = '';
        
        if (stage === 1) {
            // Stage 1: Random Cloud
            nums.forEach(n => {
                const el = document.createElement('div');
                el.className = 'number-item';
                el.innerText = n;
                el.style.left = Math.random() * 90 + '%';
                el.style.top = Math.random() * 90 + '%';
                el.style.fontSize = (Math.random() * 1.5 + 1) + 'rem'; // Random size variation
                container.appendChild(el);
            });
        } else if (stage === 2) {
            // Stage 2: 4 Quadrants (0-25, 26-50, 51-75, 76-100 approx split by count or value?)
            // Requirement: "divided into 4 quadrants, numbers distributed in order Q1->Q2->Q3->Q4->Q1..."
            // This implies spatial distribution based on index or value.
            // Let's divide canvas into 4 divs.
            container.style.display = 'grid';
            container.style.gridTemplateColumns = '1fr 1fr';
            container.style.gridTemplateRows = '1fr 1fr';
            
            const q1 = createQuadrant();
            const q2 = createQuadrant();
            const q3 = createQuadrant();
            const q4 = createQuadrant();
            container.append(q1, q2, q3, q4);
            
            // Distribute numbers: Requirement says "in order Q1->Q2->Q3->Q4->Q1"
            // So number[0] -> Q1, number[1] -> Q2, etc.
            nums.forEach((n, i) => {
                const el = document.createElement('div');
                el.className = 'number-item';
                el.innerText = n;
                // Position relatively within quadrant
                el.style.position = 'absolute';
                el.style.left = Math.random() * 80 + 10 + '%';
                el.style.top = Math.random() * 80 + 10 + '%';
                
                const mod = i % 4;
                if (mod === 0) q1.appendChild(el);
                else if (mod === 1) q2.appendChild(el);
                else if (mod === 2) q3.appendChild(el);
                else q4.appendChild(el);
            });
            
        } else if (stage === 3) {
            // Stage 3: Ordered Rows
            container.style.display = 'flex';
            container.style.flexDirection = 'column';
            container.style.justifyContent = 'center';
            container.style.alignItems = 'center';
            
            // Sort just in case, though backend sends "present" numbers which might be ordered
            // Requirement says "displayed in rows, each row ordered small to large"
            nums.sort((a,b) => a-b);
            
            const rowSize = 10;
            for (let i = 0; i < nums.length; i += rowSize) {
                const row = document.createElement('div');
                row.className = 'stage3-row';
                row.style.width = '100%';
                row.style.marginBottom = '10px';
                
                nums.slice(i, i + rowSize).forEach(n => {
                    const el = document.createElement('div');
                    el.innerText = n;
                    el.style.padding = '5px 10px';
                    el.style.background = 'rgba(255,255,255,0.1)';
                    el.style.borderRadius = '4px';
                    row.appendChild(el);
                });
                container.appendChild(row);
            }
        }
    }
    
    function createQuadrant() {
        const el = document.createElement('div');
        el.style.position = 'relative';
        el.style.border = '1px dashed rgba(255,255,255,0.2)';
        return el;
    }
    
    function showResults(results) {
        const overlay = document.getElementById('result-overlay');
        overlay.style.display = 'flex';
        document.getElementById('missing-numbers').innerText = results.missing_numbers.join(', ');
        document.getElementById('participant-count').innerText = results.participant_count;
        document.getElementById('accuracy').innerText = results.accuracy.toFixed(1) + '%';
    }
</script>
