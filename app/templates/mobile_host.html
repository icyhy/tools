{% extends "base.html" %}

{% block title %}主持人控制台{% endblock %}

{% block content %}
<div class="mobile-page">
    <div class="mobile-card">
        <h3>主持人控制台</h3>
        <p>你好，{{ participant.name }}</p>
    </div>

    <div class="mobile-card">
        <h4>可用互动</h4>
        <div style="display: grid; gap: 10px;">
            {% for plugin_id, plugin in plugins.items() %}
            <button type="button" class="btn" onclick="loadPlugin('{{ plugin_id }}')">
                {{ plugin.meta.get('name', plugin_id) }}
            </button>
            {% endfor %}
        </div>
    </div>

    <div class="mobile-card" id="plugin-container" style="display: none;">
        <h4 id="plugin-title">当前互动</h4>
        <div id="plugin-content"></div>
        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
            <button type="button" class="btn" style="background-color: #dc3545;" onclick="completePlugin()">完成互动
                (显示结果)</button>
            <div style="display: flex; gap: 5px; width: 100%;">
                <input type="number" id="countdown-seconds" placeholder="秒" style="width: 80px; padding: 10px;"
                    value="10">
                <button type="button" class="btn" style="background-color: #ffc107; color: black;"
                    onclick="startCountdown()">倒计时结束</button>
            </div>
            <button type="button" class="btn" style="background-color: #6c757d;" onclick="exitPlugin()">退出互动</button>
        </div>
    </div>

    <script>
        let currentPluginId = null;

        async function loadPlugin(pluginId) {
            try {
                // 1. Start plugin on server (sets active state and triggers display update)
                const startResponse = await fetch(`/api/plugin/${pluginId}/start`, {
                    method: 'POST'
                });

                if (!startResponse.ok) {
                    alert('启动互动失败');
                    return;
                }

                currentPluginId = pluginId;

                // 2. Load plugin control interface
                const controlResponse = await fetch(`/host/${pluginId}`);
                const html = await controlResponse.text();
                const container = document.getElementById('plugin-content');
                container.innerHTML = html;

                // Execute embedded scripts
                Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                    const newScript = document.createElement('script');
                    Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                    newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                    oldScript.parentNode.replaceChild(newScript, oldScript);
                });

                // Show plugin control container
                document.getElementById('plugin-container').style.display = 'block';
                document.getElementById('plugin-title').innerText = `当前互动: ${pluginId}`;

                alert('互动已启动，大屏应该已经更新');
            } catch (e) {
                console.error(e);
                alert('加载互动失败: ' + e.message);
            }
        }

        async function completePlugin() {
            console.log('[Host] completePlugin called');
            // TEMPORARILY REMOVED CONFIRM FOR DEBUGGING
            // if (!confirm("确定要完成当前互动并显示结果吗？")) {
            //     console.log('[Host] User cancelled');
            //     return;
            // }
            console.log('[Host] Calling /api/plugin/stop...');
            try {
                const response = await fetch(`/api/plugin/stop`, {
                    method: 'POST',
                    credentials: 'include'
                });
                console.log('[Host] Response status:', response.status);
                console.log('[Host] Response headers:', [...response.headers.entries()]);
                if (response.ok) {
                    console.log('[Host] Plugin stopped successfully');
                    alert('✅ 互动已完成，正在显示结果');
                } else {
                    const error = await response.json();
                    console.error('[Host] Stop failed:', error);
                    alert('❌ 操作失败: ' + (error.detail || '未知错误'));
                }
            } catch (e) {
                console.error('[Host] Exception:', e);
                alert('❌ 请求出错: ' + e.message);
            }
        }

        async function exitPlugin() {
            console.log('[Host] exitPlugin called');
            // TEMPORARILY REMOVED CONFIRM FOR DEBUGGING
            // if (!confirm("确定要退出互动并返回签到首页吗？")) {
            //     console.log('[Host] User cancelled');
            //     return;
            // }
            console.log('[Host] Calling /api/plugin/reset...');
            try {
                const response = await fetch(`/api/plugin/reset`, {
                    method: 'POST',
                    credentials: 'include'
                });
                console.log('[Host] Response status:', response.status);
                if (response.ok) {
                    console.log('[Host] Plugin reset successfully');
                    document.getElementById('plugin-container').style.display = 'none';
                    document.getElementById('plugin-content').innerHTML = '';
                    currentPluginId = null;
                    alert('✅ 已退出互动，大屏返回首页');
                } else {
                    const error = await response.json();
                    console.error('[Host] Reset failed:', error);
                    alert('❌ 操作失败: ' + (error.detail || error));
                }
            } catch (e) {
                console.error('[Host] Exception:', e);
                alert('❌ 请求出错: ' + e.message);
            }
        }

        async function startCountdown() {
            const seconds = document.getElementById('countdown-seconds').value;
            if (!seconds || seconds <= 0) {
                alert("请输入有效的倒计时秒数");
                return;
            }

            try {
                const response = await fetch(`/api/plugin/countdown`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ seconds: parseInt(seconds) })
                });

                if (response.ok) {
                    alert('倒计时已开始');
                } else {
                    alert('操作失败');
                }
            } catch (e) {
                console.error(e);
                alert('请求出错');
            }
        }

        // Legacy function for plugin-loaded content
        async function startPlugin(pluginId) {
            // This is called from plugin control templates, just call start API
            try {
                const response = await fetch(`/api/plugin/${pluginId}/start`, { method: 'POST' });
                if (response.ok) {
                    alert('阶段已启动');
                } else {
                    alert('启动失败');
                }
            } catch (e) {
                console.error(e);
                alert('请求出错');
            }
        }

        async function showStats() {
            if (!confirm("确定要在大屏上显示互动统计排行榜吗？")) return;
            try {
                const response = await fetch('/api/host/show_stats', { method: 'POST' });
                if (response.ok) {
                    alert('已显示统计榜单');
                } else {
                    alert('操作失败');
                }
            } catch (e) {
                console.error(e);
                alert('请求出错');
            }
        }
    </script>

    <div class="mobile-card">
        <h4>其他功能</h4>
        <button type="button" class="btn" style="background-color: #17a2b8;" onclick="showStats()">显示互动统计排行榜</button>
    </div>

    <div class="mobile-card">
        <h4>当前状态</h4>
        <p>大屏内容: 首页/签到</p>
    </div>
</div>
{% endblock %}