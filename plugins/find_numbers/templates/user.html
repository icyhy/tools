<div class="mobile-page">
    <div class="mobile-card" id="waiting-screen">
        <h3>找数字规律</h3>
        <p>请关注大屏幕，等待游戏开始...</p>
    </div>

    <div class="mobile-card" id="game-screen" style="display: none;">
        <h3>第 <span id="stage-num">1</span> 阶段</h3>
        <p>请找出大屏幕上缺失的数字 (1-100范围)</p>
        <div id="inputs-container">
            <!--  Inputs will be added here -->
        </div>
        <button class="btn" onclick="addInput()" style="margin-top: 10px;">+ 添加数字</button>
        <button class="btn" id="submit-btn" style="background-color: #28a745; margin-top: 20px;"
            onclick="submitAnswers()">提交答案</button>
        <p id="status-message" style="text-align: center; margin-top: 10px; color: #666;"></p>
    </div>

    <div class="mobile-card" id="result-screen" style="display: none;">
        <h3>本轮结束</h3>
        <p>你找对了 <span id="my-score" style="color: green; font-weight: bold;">0</span> 个数字</p>
        <p>正确答案: <span id="correct-answers"></span></p>
    </div>
</div>

<script>
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const ws = new WebSocket(`${protocol}//${window.location.host}/ws/user`);

    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data.type === 'game_start' && data.plugin_id === 'find_numbers') {
            startGame(data);
        } else if (data.type === 'game_end' && data.plugin_id === 'find_numbers') {
            endGame(data);
        }
    };

    function startGame(data) {
        document.getElementById('waiting-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'block';
        document.getElementById('stage-num').innerText = data.stage || 1;
        document.getElementById('status-message').innerText = '';

        // Reset inputs
        const container = document.getElementById('inputs-container');
        container.innerHTML = '';
        // Add 3 default inputs
        for (let i = 0; i < 3; i++) addInput();

        // Re-enable submit button
        document.getElementById('submit-btn').disabled = false;
    }

    function addInput() {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.marginBottom = '10px';
        div.innerHTML = `<input type="number" class="answer-input form-control" placeholder="输入缺失数字" min="1" max="100" style="padding: 10px; font-size: 1rem; border: 1px solid #ddd; border-radius: 5px; width: 100%;">`;
        document.getElementById('inputs-container').appendChild(div);
    }

    async function submitAnswers() {
        const inputs = document.getElementsByClassName('answer-input');
        const answers = [];
        for (let input of inputs) {
            const val = parseInt(input.value);
            if (!isNaN(val) && val >= 1 && val <= 100) {
                answers.push(val);
            }
        }

        if (answers.length === 0) {
            document.getElementById('status-message').innerText = '请至少输入一个数字';
            document.getElementById('status-message').style.color = '#dc3545';
            return;
        }

        // Disable button to prevent double submit
        const submitBtn = document.getElementById('submit-btn');
        submitBtn.disabled = true;
        submitBtn.innerText = '提交中...';

        try {
            const response = await fetch('/api/plugin/find_numbers/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ answers: answers })
            });

            if (response.ok) {
                const result = await response.json();

                document.getElementById('game-screen').style.display = 'none';
                document.getElementById('waiting-screen').style.display = 'block';
                document.getElementById('waiting-screen').innerHTML = `
                    <h3>✓ 已提交</h3>
                    <p>你提交了: ${answers.join(', ')}</p>
                    <p>等待本轮结束...</p>
                `;
            } else {
                document.getElementById('status-message').innerText = '✗ 提交失败,请重试';
                document.getElementById('status-message').style.color = '#dc3545';
                submitBtn.disabled = false;
                submitBtn.innerText = '提交答案';
            }

        } catch (e) {
            console.error('提交错误:', e);
            document.getElementById('status-message').innerText = '✗ 网络错误';
            document.getElementById('status-message').style.color = '#dc3545';
            submitBtn.disabled = false;
            submitBtn.innerText = '提交答案';
        }
    }

    function endGame(data) {
        document.getElementById('waiting-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('result-screen').style.display = 'block';

        // Show correct answers
        if (data.results && data.results.missing_numbers) {
            document.getElementById('correct-answers').innerText = data.results.missing_numbers.join(', ');
        }
    }
</script>