{% extends "base.html" %}

{% block title %}主持人控制台{% endblock %}

{% block content %}
<div class="mobile-page">
    <div class="mobile-card">
        <h3>主持人控制台</h3>
        <p>你好，{{ participant.name }}</p>
    </div>

    <div class="mobile-card">
        <div class="mobile-card">
            <h4>可用互动</h4>
            <div style="display: grid; gap: 10px;">
                {% if interactions %}
                {% for interaction in interactions %}
                <button type="button" class="btn" onclick="loadPlugin('{{ interaction.id }}')">
                    {{ interaction.name }}
                    <span style="font-size:0.75em; display:block; opacity:0.8; font-weight:normal;">{{
                        interaction.plugin_id }}</span>
                </button>
                {% endfor %}
                {% else %}
                <p>暂无配置的互动</p>
                <p style="font-size: 0.9em; color: #888;">请先在管理员后台配置互动。</p>
                {% endif %}
            </div>
        </div>

        <div class="mobile-card" id="plugin-container" style="display: none;">
            <h4 id="plugin-title">当前互动</h4>
            <div id="plugin-content"></div>
            <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                <button type="button" class="btn" style="background-color: #dc3545;" onclick="completePlugin()">完成互动
                    (显示结果)</button>
                <div style="display: flex; gap: 5px; width: 100%;">
                    <input type="number" id="countdown-seconds" placeholder="秒" style="width: 80px; padding: 10px;"
                        value="10">
                    <button type="button" class="btn" style="background-color: #ffc107; color: black;"
                        onclick="startCountdown()">倒计时结束</button>
                </div>
                <button type="button" class="btn" style="background-color: #6c757d;"
                    onclick="exitPlugin()">退出互动</button>
            </div>
        </div>

        <script>
            let currentInteractionId = null;

            async function loadPlugin(interactionId) {
                console.log('Loading plugin:', interactionId);
                try {
                    const startResponse = await fetch(`/api/plugin/${interactionId}/start`, {
                        method: 'POST'
                    });

                    if (!startResponse.ok) {
                        let detail = startResponse.statusText;
                        try {
                            const errorData = await startResponse.json();
                            detail = errorData.detail || detail;
                        } catch (e) {
                            const text = await startResponse.text();
                            detail = text || detail;
                        }
                        alert('启动互动失败: ' + detail);
                        return;
                    }

                    currentInteractionId = interactionId;

                    const pluginContainer = document.getElementById('plugin-container');
                    if (pluginContainer) {
                        pluginContainer.style.display = 'block';
                        const pluginTitle = document.getElementById('plugin-title');
                        if (pluginTitle) pluginTitle.innerText = `当前互动: ${interactionId}`;
                    }

                    const statusCard = Array.from(document.querySelectorAll('.mobile-card')).find(card => {
                        const h4 = card.querySelector('h4');
                        return h4 && h4.innerText.includes('当前状态');
                    });
                    if (statusCard) {
                        const statusText = statusCard.querySelector('p:last-child');
                        if (statusText) statusText.innerText = '大屏内容: 正在互动';
                    }

                    const container = document.getElementById('plugin-content');
                    if (container) {
                        container.innerHTML = '<p style="color:#666;">正在加载控制台...</p>';
                    }

                    const controlResponse = await fetch(`/mobile/plugin/${interactionId}`);
                    if (!controlResponse.ok) {
                        let detail = controlResponse.statusText;
                        try {
                            const text = await controlResponse.text();
                            detail = text || detail;
                        } catch (e) {
                            detail = controlResponse.statusText;
                        }
                        if (container) {
                            container.innerHTML = `<p style="color:#dc3545;">控制台加载失败：${detail}</p>`;
                        }
                        alert('加载控制台失败: ' + detail);
                        return;
                    }
                    const html = await controlResponse.text();
                    if (container) {
                        container.innerHTML = html;

                        Array.from(container.querySelectorAll('script')).forEach(oldScript => {
                            const newScript = document.createElement('script');
                            Array.from(oldScript.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value));
                            newScript.appendChild(document.createTextNode(oldScript.innerHTML));
                            oldScript.parentNode.replaceChild(newScript, oldScript);
                        });
                    }

                    console.log('Plugin loaded and UI updated');
                } catch (e) {
                    console.error('Load plugin error:', e);
                    alert('加载互动失败: ' + e.message);
                }
            }

            async function completePlugin() {
                console.log('[Host] completePlugin called');
                try {
                    const response = await fetch(`/api/plugin/stop`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        alert('互动已完成 (显示结果环境)');
                    } else {
                        const errorData = await response.json();
                        alert('操作失败: ' + (errorData.detail || response.statusText));
                    }
                } catch (e) {
                    alert('错误:' + e.message);
                }
            }

            async function exitPlugin() {
                console.log('[Host] exitPlugin called');
                if (!confirm("确定要退出互动并返回大屏首页吗？")) return;
                try {
                    const response = await fetch(`/api/plugin/reset`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    if (response.ok) {
                        document.getElementById('plugin-container').style.display = 'none';
                        currentInteractionId = null;
                        alert('已退出互动');

                        const statusText = document.querySelector('.mobile-card p:last-child');
                        if (statusText && statusText.parentElement.querySelector('h4').innerText.includes('当前状态')) {
                            statusText.innerText = '大屏内容: 首页/签到';
                        }
                    } else {
                        const errorData = await response.json();
                        alert('操作失败: ' + (errorData.detail || response.statusText));
                    }
                } catch (e) {
                    alert('错误:' + e.message);
                }
            }

            async function startCountdown() {
                const secondsInput = document.getElementById('countdown-seconds');
                const seconds = parseInt(secondsInput.value) || 10;
                console.log('[Host] startCountdown called', seconds);
                try {
                    const response = await fetch('/api/plugin/countdown', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ seconds: seconds })
                    });
                    if (response.ok) {
                        alert('倒计时已启动');
                    } else {
                        alert('操作失败');
                    }
                } catch (e) {
                    alert('错误:' + e.message);
                }
            }

            async function showStats() {
                if (!confirm("确定要在大屏上显示互动统计排行榜吗？")) return;
                try {
                    const response = await fetch('/api/host/show_stats', { method: 'POST' });
                    if (response.ok) {
                        alert('已显示统计榜单');
                    } else {
                        alert('操作失败');
                    }
                } catch (e) {
                    console.error(e);
                    alert('请求出错');
                }
            }
        </script>

        <div class="mobile-card">
            <h4>其他功能</h4>
            <button type="button" class="btn" style="background-color: #17a2b8;"
                onclick="showStats()">显示互动统计排行榜</button>
        </div>

        <div class="mobile-card">
            <h4>当前状态</h4>
            <p>大屏内容: 首页/签到</p>
        </div>
    </div>
    {% endblock %}
