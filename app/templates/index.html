{% extends "base.html" %}

{% block title %}{{ event.title }} - 大屏{% endblock %}

{% block content %}
<div class="display-page">
    <!-- 首页内容 - 独立于动态容器 -->
    <div class="display-page-home" id="display-page-home">
        {% if event.logo_url %}
        <img src="{{ event.logo_url }}" class="home-logo" alt="Logo">
        {% endif %}
        <div class="home-title">{{ event.title }}</div>

        {% if event.status == 'running' %}
        <div class="home-qr-container">
            <img src="{{ qr_code }}" class="home-qr-img" alt="Scan to Sign In">
        </div>

        <div class="home-stats">
            已签到: <span id="count" class="count-display">{{ participant_count }}</span> 人
        </div>

        <div class="home-url">
            {{ signin_url }}
        </div>
        {% else %}
        <div style="font-size: 2rem; color: #666; margin-top: 50px;">
            <p>培训尚未开始，请等待...</p>
        </div>
        {% endif %}
    </div>

    <!-- 动态内容容器 - 互动内容在这里动态加载 -->
    <div id="dynamic-content-container"></div>
</div>

<div id="countdown-overlay" class="countdown-overlay" style="display: none;">
    <span id="countdown-number"></span>
</div>

<script>
    // ========== 状态轮询机制（主要同步方式） ==========
    let localState = {
        plugin_id: null,
        plugin_state: null,
        last_check: 0
    };

    // 定时轮询培训状态（每2秒）
    setInterval(async () => {
        try {
            const response = await fetch('/api/training/status');
            if (response.ok) {
                const serverState = await response.json();

                // 检查状态是否改变
                if (serverState.plugin_id !== localState.plugin_id ||
                    serverState.plugin_state !== localState.plugin_state) {

                    console.log('State changed:', localState, '->', serverState);

                    // 根据新状态更新display内容
                    if (serverState.plugin_id && serverState.plugin_state === 'running') {
                        loadPluginContent(serverState.plugin_id);
                    } else if (serverState.plugin_id && serverState.plugin_state === 'results') {
                        loadPluginResults(serverState.plugin_id);
                    } else if (!serverState.plugin_id || serverState.plugin_state === 'idle') {
                        // 返回首页
                        resetToHome();
                    }

                    // 更新本地状态
                    localState = serverState;
                }
            }
        } catch (e) {
            console.error('Failed to poll training status', e);
        }
    }, 2000);  // 2秒轮询一次

    // ========== WebSocket（作为辅助/实时更新） ==========

    // WebSocket Connection
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws/display`;
    const ws = new WebSocket(wsUrl);

    ws.onmessage = function (event) {
        const data = JSON.parse(event.data);
        if (data.type === 'stats_update') {
            // Update count in both header and home body if they exist
            // Use querySelectorAll to update all instances if multiple exist (unlikely but safe)
            const countEls = document.querySelectorAll('#count');
            countEls.forEach(el => el.innerText = data.count);

            // Also update header stats specifically if ID is different
            // In current template, both use id="count". 
            // Ideally we should use class="count-display"
            const countClassEls = document.querySelectorAll('.count-display');
            countClassEls.forEach(el => el.innerText = data.count);
        } else if (data.type === 'plugin_start') {
            // 动态加载插件内容，不跳转URL
            loadPluginContent(data.plugin_id);
        } else if (data.type === 'plugin_end') {
            document.getElementById('countdown-overlay').style.display = 'none';
            loadPluginResults(data.plugin_id);
        } else if (data.type === 'countdown_start') {
            startCountdown(data.seconds);
        } else if (data.type === 'plugin_reset') {
            resetToHome();
        } else if (data.type === 'plugin_phase_change') {
            // Notify embedded plugin content about phase change
            const iframe = document.querySelector('iframe');
            if (iframe && iframe.contentWindow) {
                iframe.contentWindow.postMessage({ type: 'phase_change', phase: data.phase }, '*');
            }
            // Also try direct function call if plugin sets it up
            if (window.pluginPhaseListener) {
                window.pluginPhaseListener(data.phase);
            }
            // Try to find and call setPhase in dynamic content
            const container = document.getElementById('dynamic-content-container');
            if (container && typeof setPhase === 'function') {
                setPhase(data.phase);
            }
        }
    };

    function startCountdown(seconds) {
        const overlay = document.getElementById('countdown-overlay');
        const number = document.getElementById('countdown-number');
        overlay.style.display = 'flex';
        number.innerText = seconds;

        let remaining = seconds;
        const interval = setInterval(() => {
            remaining--;
            if (remaining > 0) {
                number.innerText = remaining;
            } else {
                clearInterval(interval);
                overlay.style.display = 'none';
                // Server should send plugin_end shortly
            }
        }, 1000);
    }


    // 动态加载插件内容到容器中
    async function loadPluginContent(pluginId) {
        try {
            const response = await fetch(`/display/${pluginId}`);
            if (response.ok) {
                const html = await response.text();

                // Hide home page
                const homePage = document.getElementById('display-page-home');
                if (homePage) {
                    homePage.style.display = 'none';
                }

                // Load plugin content
                const container = document.getElementById('dynamic-content-container');
                container.innerHTML = html;
                executeScripts(container);
                console.log('Plugin loaded:', pluginId);
            }
        } catch (e) {
            console.error("Failed to load plugin content", e);
        }
    }

    // 加载插件结果
    async function loadPluginResults(pluginId) {
        try {
            const response = await fetch(`/display/results/${pluginId}`);
            if (response.ok) {
                const html = await response.text();

                // Hide home page
                const homePage = document.getElementById('display-page-home');
                if (homePage) {
                    homePage.style.display = 'none';
                }

                // Load results content  
                const container = document.getElementById('dynamic-content-container');
                container.innerHTML = html;
                executeScripts(container);
            }
        } catch (e) {
            console.error("Failed to load results", e);
        }
    }

    // 返回签到首页
    async function resetToHome() {
        // Clear plugin content
        const container = document.getElementById('dynamic-content-container');
        container.innerHTML = '';

        // Show home page
        const homePage = document.getElementById('display-page-home');
        if (homePage) {
            homePage.style.display = 'flex';
        }

        // Fetch and update participant count
        try {
            const response = await fetch('/api/training/status');
            if (response.ok) {
                const data = await response.json();
                // Update all count displays
                const countEls = document.querySelectorAll('#count, .count-display');
                countEls.forEach(el => {
                    if (el) el.innerText = data.participant_count || '0';
                });
            }
        } catch (e) {
            console.error('Failed to fetch participant count', e);
        }

        console.log('Display reset to home page');
    }

    // 执行动态加载HTML中的脚本
    function executeScripts(container) {
        const scripts = container.querySelectorAll('script');
        scripts.forEach(oldScript => {
            const newScript = document.createElement('script');
            Array.from(oldScript.attributes).forEach(attr => {
                newScript.setAttribute(attr.name, attr.value);
            });
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }



    ws.onclose = function () {
        console.log("WebSocket disconnected. Retrying in 5s...");
        setTimeout(() => location.reload(), 5000);
    };

    // Fallback polling (keep it just in case)
    setInterval(async () => {
        try {
            const response = await fetch('/api/stats/count');
            const data = await response.json();
            document.getElementById('count').innerText = data.count;
        } catch (e) {
            console.error("Failed to update stats", e);
        }
    }, 10000); // Slower polling
</script>
{% endblock %}